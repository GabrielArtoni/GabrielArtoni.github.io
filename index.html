<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Colaboradores</title>

  <!-- ðŸ‘‡ CORRIGIDO: usa versÃ£o oficial estÃ¡vel -->
  <script src="https://cdn.senior.com.br/bpm/1.10.0/workflow-cockpit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/iframe-resizer/3.5.14/iframeResizer.contentWindow.min.js"></script>
</head>

<body>
  <h2>Consulta de Colaboradores</h2>
  <button onclick="consultarColaboradores()">Consultar</button>
  <br><br>
  <table id="resultado" border="1">
    <thead>
      <tr>
        <th>CÃ³digo</th>
        <th>Nome</th>
        <th>Empresa</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let context;

    window.onload = async () => {
      try {
        context = await cockpit.init();
        console.log('Cockpit inicializado com sucesso!');
      } catch (err) {
        alert('Erro ao inicializar cockpit. Verifique se o formulÃ¡rio estÃ¡ sendo aberto dentro do BPM.');
      }
    };

    async function consultarColaboradores() {
      if (!context) {
        alert('Cockpit ainda nÃ£o carregado â€” abra via BPM.');
        return;
      }

      try {
        const resposta = await context.callPlugin({
          plugin: 'platform.bpm_timeout',
          method: 'queries/invoke',
          data: {
            id: 'f2200c3b-c7df-4040-9613-34f697b75889',
            configurationId: 'f598276b-4931-4abd-9d67-3e32ec70159c',
            inputData: {
              server: 'http://hc240105fbz3117.cloudhialinx.com.br:12507',
              module: 'rubi',
              port: 'consult_colab_teste',
              service: 'integrador_bpm_testevarios',
              user: 'senior',
              password: 'senior',
              encryption: '0',
              rootObject: 'grid'
            },
            ticketRequest: '0c767ce3-5055-4799-99ae-8a70d34a565d'
          }
        });

        const grid = resposta.data?.grid || [];
        const tbody = document.querySelector('#resultado tbody');
        tbody.innerHTML = '';

        grid.forEach(colab => {
          tbody.innerHTML += `
            <tr>
              <td>${colab.codigo || '-'}</td>
              <td>${colab.nome || '-'}</td>
              <td>${colab.empresa || '-'}</td>
            </tr>`;
        });

      } catch (erro) {
        alert('Erro ao consultar plugin: ' + (erro.message || JSON.stringify(erro)));
      }
    }
  </script>
</body>
</html>
